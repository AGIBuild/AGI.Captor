# Release Workflow

## Overview

AGI.Kapster uses an automated release workflow powered by GitHub Actions, featuring multi-platform builds, automated packaging, and seamless GitHub Release creation with a locked version + tag-driven deterministic model.

## Core Components

### 1. Locked Time-Based Versioning

- No longer uses GitVersion for dynamic version calculation
- Versions are generated by NUKE target `UpgradeVersion` and written to root `version.json`, then **locked**
- Release tags must be created with exact version match: tag name `v<version>` must match `version.json` field
- Full cross-platform release only executes when pushing compliant version tags
- Workflow includes concurrency control, ancestor validation, artifact integrity, SHA256 manifest verification, and categorized changelog generation

### 2. Release Triggers

#### Tag-Based Release
```bash
# Create and push version tag
git tag v2024.09.23.1
git push origin v2024.09.23.1
```

#### Manual Release
```bash
# Trigger manual release via GitHub Actions
gh workflow run release.yml
```

### 3. Multi-Platform Build Matrix

| Platform | Runtime | Package Format | Distribution |
|----------|---------|----------------|--------------|
| Windows | win-x64 | MSI, ZIP | GitHub Releases |
| macOS | osx-x64, osx-arm64 | PKG, DMG | GitHub Releases |
| Linux | linux-x64 | DEB, RPM, TAR.GZ | GitHub Releases |

## Automated Workflow Steps

### 1. Version Validation
- Validates tag format matches `v{major}.{minor}.{patch}.{build}`
- Verifies tag version matches `version.json`
- Ensures no duplicate tags exist

### 2. Multi-Platform Build
```yaml
strategy:
  matrix:
    os: [ubuntu-latest, windows-latest, macos-latest]
    include:
      - os: ubuntu-latest
        runtime: linux-x64
      - os: windows-latest
        runtime: win-x64
      - os: macos-latest
        runtime: osx-x64
```

### 3. Packaging Pipeline
- **Windows**: Creates MSI installer using WiX Toolset
- **macOS**: Generates PKG installer and optional DMG
- **Linux**: Builds DEB and RPM packages

### 4. Release Creation
- Automatically creates GitHub Release
- Uploads all platform artifacts
- Generates categorized changelog from commits
- Includes SHA256 checksums for verification

## Development Workflow

### 1. Feature Development
```bash
# Create feature branch
git checkout -b feature/new-overlay-mode

# Make changes and commit
git commit -m "feat: add new overlay selection mode"
git push origin feature/new-overlay-mode

# Create pull request
gh pr create --title "Add new overlay selection mode"
```

### 2. Release Preparation
```bash
# Update version using NUKE
./build.ps1 UpgradeVersion

# Commit version change
git add version.json
git commit -m "chore: bump version to 2024.09.23.1"
git push origin release

# Create and push release tag
git tag v2024.09.23.1
git push origin v2024.09.23.1
```

### 3. Post-Release
- Monitor GitHub Actions for build completion
- Verify all platform artifacts are uploaded
- Test release artifacts on target platforms
- Update documentation if needed

## Quality Gates

### Pre-Release Validation
- ✅ All tests must pass
- ✅ Code coverage threshold met
- ✅ No critical security vulnerabilities
- ✅ Version validation successful

### Artifact Verification
- ✅ SHA256 checksums generated
- ✅ Package signatures valid
- ✅ Cross-platform compatibility verified
- ✅ Installation testing completed

## Troubleshooting

### Common Issues

#### Version Mismatch
```bash
# Error: Tag version doesn't match version.json
# Solution: Update version.json or recreate tag
./build.ps1 UpgradeVersion
git tag -d v2024.09.23.1
git tag v2024.09.23.2
```

#### Build Failures
```bash
# Check build logs in GitHub Actions
gh run list --workflow=release.yml
gh run view <run-id> --log
```

#### Package Issues
```bash
# Verify package integrity
sha256sum -c checksums.txt
```

### Rollback Strategy
```bash
# Delete problematic release
gh release delete v2024.09.23.1

# Remove git tag
git tag -d v2024.09.23.1
git push origin --delete v2024.09.23.1

# Fix issues and recreate
./build.ps1 UpgradeVersion
git tag v2024.09.23.2
git push origin v2024.09.23.2
```

## Best Practices

### Version Management
- Use time-based versioning for predictability
- Always test version bumps in feature branches
- Maintain version.json accuracy before tagging

### Release Planning
- Schedule releases during low-traffic periods
- Prepare rollback plans for critical releases
- Coordinate with stakeholders for major releases

### Documentation
- Update changelogs before releasing
- Document breaking changes clearly
- Maintain platform-specific installation guides

## Monitoring & Metrics

### Release Health
- Monitor download statistics
- Track installation success rates
- Collect user feedback on new releases

### Automation Metrics
- Build success rate: Target 95%+
- Average release time: Target 30 minutes
- Artifact upload success: Target 100%

## Security Considerations

### Code Signing
- Windows: Authenticode signing for MSI packages
- macOS: Apple Developer signing for PKG/DMG
- Linux: GPG signing for DEB/RPM packages

### Vulnerability Scanning
- Automated dependency scanning in CI
- Container image security scanning
- Binary artifact malware scanning

### Supply Chain Security
- Reproducible builds with locked dependencies
- SBOM (Software Bill of Materials) generation
- Provenance attestation for releases