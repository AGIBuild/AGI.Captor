<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">
  <Package Name="AGI Captor"
           Language="1033"
           Version="!(bind.FileVersion.AGI.Captor.Desktop.exe)"
           Manufacturer="AGI Build"
           ProductCode="*"
           UpgradeCode="12345678-1234-1234-1234-123456789012"
           InstallerVersion="500"
           Compressed="yes">
    
    <!-- 升级配置：支持智能版本升级和同版本修复 -->
    <MajorUpgrade 
      AllowSameVersionUpgrades="yes"
      AllowDowngrades="no"
      DowngradeErrorMessage="A newer version of [ProductName] is already installed. Please uninstall the newer version first."
      Schedule="afterInstallInitialize" />

    <!-- 自定义操作：终止运行中的进程 -->
    <CustomAction Id="CA_KillProcess"
                  Directory="INSTALLFOLDER"
                  Execute="immediate"
                  ExeCommand='taskkill /f /im "AGI.Captor.Desktop.exe" /t'
                  Return="ignore" />

    <!-- 自定义操作：清理用户数据目录 -->
    <CustomAction Id="CA_RemoveUserData"
                  Directory="INSTALLFOLDER"
                  Execute="deferred"
                  Impersonate="yes"
                  ExeCommand='cmd.exe /c "if exist "%LOCALAPPDATA%\AGI.Captor" rmdir /s /q "%LOCALAPPDATA%\AGI.Captor""'
                  Return="ignore" />

    <!-- 自定义操作：安装完成后启动应用程序 -->
    <CustomAction Id="CA_LaunchApplication"
                  Directory="INSTALLFOLDER"
                  Execute="immediate"
                  Impersonate="yes"
                  ExeCommand='"[INSTALLFOLDER]AGI.Captor.Desktop.exe"'
                  Return="asyncNoWait" />

    <!-- 媒体配置 -->
    <Media Id="1" Cabinet="product.cab" EmbedCab="yes" />

    <!-- 安装目录结构 -->
    <StandardDirectory Id="ProgramFiles6432Folder">
      <Directory Id="INSTALLFOLDER" Name="AGI Captor" />
    </StandardDirectory>
    
    <!-- 开始菜单 -->
    <StandardDirectory Id="ProgramMenuFolder">
      <Directory Id="ApplicationProgramsFolder" Name="AGI Captor" />
    </StandardDirectory>
    
    <!-- 桌面 -->
    <StandardDirectory Id="DesktopFolder" />

    <!-- 组件：主应用程序文件 -->
    <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
      <Component Id="AGI.Captor.Desktop.exe" Guid="*">
        <File Id="AGI.Captor.Desktop.exe" Source="$(var.SourceDir)\AGI.Captor.Desktop.exe" KeyPath="yes" />
      </Component>
      
      <!-- PDB 调试文件 (可选) -->
      <Component Id="DebugFiles" Guid="12345678-1234-1234-1234-123456789021">
        <File Id="AGI.Captor.Desktop.pdb" Source="$(var.SourceDir)\AGI.Captor.Desktop.pdb" KeyPath="yes" />
      </Component>
      
      <!-- 配置文件 -->
      <Component Id="ConfigFiles" Guid="12345678-1234-1234-1234-123456789022">
        <File Id="appsettings.json" Source="$(var.SourceDir)\appsettings.json" KeyPath="yes" />
      </Component>
      
      <Component Id="ConfigDevFiles" Guid="12345678-1234-1234-1234-123456789023">
        <File Id="appsettings.Development.json" Source="$(var.SourceDir)\appsettings.Development.json" KeyPath="yes" />
      </Component>
      
      <Component Id="ConfigProdFiles" Guid="12345678-1234-1234-1234-123456789024">
        <File Id="appsettings.Production.json" Source="$(var.SourceDir)\appsettings.Production.json" KeyPath="yes" />
      </Component>
      
      <!-- SkiaSharp 原生库 -->
      <Component Id="SkiaSharpNative" Guid="12345678-1234-1234-1234-123456789025">
        <File Id="libSkiaSharp.dll" Source="$(var.SourceDir)\libSkiaSharp.dll" KeyPath="yes" />
      </Component>
      
      <!-- Avalonia 原生库 -->
      <Component Id="AvaloniaNative" Guid="12345678-1234-1234-1234-123456789026">
        <File Id="av_libglesv2.dll" Source="$(var.SourceDir)\av_libglesv2.dll" KeyPath="yes" />
      </Component>
      
      <!-- HarfBuzz 库 -->
      <Component Id="HarfBuzzNative" Guid="12345678-1234-1234-1234-123456789027">
        <File Id="libHarfBuzzSharp.dll" Source="$(var.SourceDir)\libHarfBuzzSharp.dll" KeyPath="yes" />
      </Component>
      
      <!-- Uiohook 库 -->
      <Component Id="UiohookNative" Guid="12345678-1234-1234-1234-123456789028">
        <File Id="uiohook.dll" Source="$(var.SourceDir)\uiohook.dll" KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <!-- 开始菜单快捷方式 -->
    <Component Id="ApplicationShortcut" Directory="ApplicationProgramsFolder" Guid="*">
      <Shortcut Id="ApplicationStartMenuShortcut"
                Name="AGI Captor"
                Description="Advanced Screenshot and Annotation Tool"
                Target="[INSTALLFOLDER]AGI.Captor.Desktop.exe"
                WorkingDirectory="INSTALLFOLDER" />
      <RemoveFolder Id="ApplicationProgramsFolder" On="uninstall" />
      <RegistryValue Root="HKCU" Key="Software\AGI Build\AGI Captor" Name="installed" Type="integer" Value="1" KeyPath="yes" />
    </Component>

    <!-- 桌面快捷方式 -->
    <Component Id="DesktopShortcut" Directory="DesktopFolder" Guid="*">
      <Shortcut Id="ApplicationDesktopShortcut"
                Name="AGI Captor"
                Description="Advanced Screenshot and Annotation Tool"
                Target="[INSTALLFOLDER]AGI.Captor.Desktop.exe"
                WorkingDirectory="INSTALLFOLDER" />
      <RegistryValue Root="HKCU" Key="Software\AGI Build\AGI Captor" Name="desktop" Type="integer" Value="1" KeyPath="yes" />
    </Component>

    <!-- 注册表项：文件关联和应用程序信息 -->
    <Component Id="RegistryEntries" Directory="INSTALLFOLDER" Guid="*">
      <!-- 应用程序注册 -->
      <RegistryKey Root="HKLM" Key="SOFTWARE\AGI Build\AGI Captor">
        <RegistryValue Name="InstallPath" Type="string" Value="[INSTALLFOLDER]" />
        <RegistryValue Name="Version" Type="string" Value="[ProductVersion]" />
        <RegistryValue Name="Publisher" Type="string" Value="AGI Build" />
        <RegistryValue Name="ProductCode" Type="string" Value="[ProductCode]" />
        <RegistryValue Name="UpgradeCode" Type="string" Value="12345678-1234-1234-1234-123456789012" />
        <RegistryValue Name="InstallDate" Type="string" Value="[Date]" />
      </RegistryKey>
      
      <!-- 卸载程序注册：使用ProductCode作为唯一键名避免重复安装 -->
      <RegistryKey Root="HKLM" Key="SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\[ProductCode]">
        <RegistryValue Name="DisplayName" Type="string" Value="AGI Captor" />
        <RegistryValue Name="DisplayVersion" Type="string" Value="[ProductVersion]" />
        <RegistryValue Name="Publisher" Type="string" Value="AGI Build" />
        <RegistryValue Name="InstallLocation" Type="string" Value="[INSTALLFOLDER]" />
        <RegistryValue Name="UninstallString" Type="string" Value="[SystemFolder]msiexec.exe /x [ProductCode]" />
        <RegistryValue Name="QuietUninstallString" Type="string" Value="[SystemFolder]msiexec.exe /x [ProductCode] /quiet" />
        <RegistryValue Name="ModifyPath" Type="string" Value="[SystemFolder]msiexec.exe /i [ProductCode]" />
        <RegistryValue Name="NoModify" Type="integer" Value="1" />
        <RegistryValue Name="NoRepair" Type="integer" Value="0" />
        <RegistryValue Name="EstimatedSize" Type="integer" Value="90000" />
        <RegistryValue Name="HelpLink" Type="string" Value="https://github.com/AGIBuild/AGI.Captor" />
        <RegistryValue Name="URLInfoAbout" Type="string" Value="https://github.com/AGIBuild/AGI.Captor" />
        <RegistryValue Name="URLUpdateInfo" Type="string" Value="https://github.com/AGIBuild/AGI.Captor/releases" />
        <RegistryValue Name="InstallDate" Type="string" Value="[Date]" />
        <RegistryValue Name="Language" Type="integer" Value="1033" />
        <RegistryValue Name="SystemComponent" Type="integer" Value="0" />
        <RegistryValue Name="VersionMajor" Type="integer" Value="1" />
        <RegistryValue Name="VersionMinor" Type="integer" Value="2" />
      </RegistryKey>
      
      <!-- 用户数据保护标记 -->
      <RegistryKey Root="HKLM" Key="SOFTWARE\AGI Build\AGI Captor\UserData">
        <RegistryValue Name="PreserveOnUninstall" Type="integer" Value="1" />
        <RegistryValue Name="BackupOnUpgrade" Type="integer" Value="1" />
        <RegistryValue Name="UserDataPath" Type="string" Value="%LOCALAPPDATA%\AGI.Captor" />
      </RegistryKey>
    </Component>

    <!-- 用户数据保护组件 -->
    <Component Id="UserDataProtection" Directory="INSTALLFOLDER" Guid="*">
      <RegistryValue Root="HKCU" Key="Software\AGI Build\AGI Captor\UserData" 
                     Name="PreserveSettings" Type="integer" Value="1" KeyPath="yes" />
      <RegistryValue Root="HKCU" Key="Software\AGI Build\AGI Captor\UserData" 
                     Name="LastUpgrade" Type="string" Value="[Date]" />
      <RegistryValue Root="HKCU" Key="Software\AGI Build\AGI Captor\UserData" 
                     Name="Version" Type="string" Value="[ProductVersion]" />
    </Component>

    <!-- 功能定义 -->
    <Feature Id="ProductFeature" Title="AGI Captor" Level="1">
      <ComponentGroupRef Id="ProductComponents" />
      <ComponentRef Id="ApplicationShortcut" />
      <ComponentRef Id="DesktopShortcut" />
      <ComponentRef Id="RegistryEntries" />
      <ComponentRef Id="UserDataProtection" />
    </Feature>

    <!-- 安装序列：定义自定义操作的执行顺序 -->
    <InstallExecuteSequence>
      <!-- 安装前：终止运行中的进程 -->
      <Custom Action="CA_KillProcess" Before="InstallValidate" Condition="NOT Installed" />
      
      <!-- 安装完成后：默认启动应用程序 -->
      <Custom Action="CA_LaunchApplication" After="InstallFinalize" Condition="NOT Installed" />
    </InstallExecuteSequence>

    <!-- 属性定义 -->
    <Property Id="CLEANUP_USER_DATA" Value="0" />

    <!-- 禁用某些安装选项以简化用户体验 -->
    <Property Id="ARPHELPLINK" Value="https://github.com/AGIBuild/AGI.Captor" />
    <Property Id="ARPURLINFOABOUT" Value="https://github.com/AGIBuild/AGI.Captor" />
    <Property Id="ARPNOMODIFY" Value="1" />
    <Property Id="ARPNOREPAIR" Value="0" />

    <!-- 应用程序图标 -->
    <Property Id="ARPPRODUCTICON" Value="ProductIcon" />
    <Icon Id="ProductIcon" SourceFile="$(var.SourceDir)\..\..\..\src\AGI.Captor.Desktop\logo.ico" />

    <!-- 系统要求检查 - 优化为更合理的条件 -->
    <!-- Windows 8.1+ (VersionNT >= 603) 支持大多数现代应用 -->
    <Launch Condition="Installed OR (VersionNT >= 603)" 
            Message="This application requires Windows 8.1 or later. Please upgrade your operating system." />
    
    <!-- 自包含部署的.NET 9.0应用不需要额外的运行时检查 -->

  </Package>
</Wix>