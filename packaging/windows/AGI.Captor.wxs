<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">
  <Package Name="AGI Captor"
           Language="1033"
           Version="1.2.0.0"
           Manufacturer="AGI Build"
           UpgradeCode="12345678-1234-1234-1234-123456789012">
    
    <!-- 升级配置 -->
    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
    
    <!-- 媒体配置 -->
    <MediaTemplate EmbedCab="yes" />

    <!-- 功能配置 -->
    <Feature Id="ProductFeature" Title="AGI Captor" Level="1">
      <ComponentGroupRef Id="ProductComponents" />
      <ComponentRef Id="ApplicationShortcut" />
      <ComponentRef Id="DesktopShortcut" />
    </Feature>

    <!-- 安装目录结构 -->
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFiles64Folder">
        <Directory Id="INSTALLFOLDER" Name="AGI Captor" />
      </Directory>
      
      <!-- 开始菜单 -->
      <Directory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="AGI Captor" />
      </Directory>
      
      <!-- 桌面 -->
      <Directory Id="DesktopFolder" Name="Desktop" />
    </Directory>

    <!-- 应用程序快捷方式 -->
    <DirectoryRef Id="ApplicationProgramsFolder">
      <Component Id="ApplicationShortcut" Guid="12345678-1234-1234-1234-123456789013">
        <Shortcut Id="ApplicationStartMenuShortcut"
                  Name="AGI Captor"
                  Description="Advanced Screenshot and Annotation Tool"
                  Target="[#AGI.Captor.Desktop.exe]"
                  WorkingDirectory="INSTALLFOLDER"
                  Icon="AGI.Captor.ico" />
        <RemoveFolder Id="CleanUpShortCut" Directory="ApplicationProgramsFolder" On="uninstall" />
        <RegistryValue Root="HKCU" 
                       Key="Software\AGI\Captor" 
                       Name="installed" 
                       Type="integer" 
                       Value="1" 
                       KeyPath="yes" />
      </Component>
    </DirectoryRef>

    <!-- 桌面快捷方式 -->
    <DirectoryRef Id="DesktopFolder">
      <Component Id="DesktopShortcut" Guid="12345678-1234-1234-1234-123456789014">
        <Shortcut Id="ApplicationDesktopShortcut"
                  Name="AGI Captor"
                  Description="Advanced Screenshot and Annotation Tool"
                  Target="[#AGI.Captor.Desktop.exe]"
                  WorkingDirectory="INSTALLFOLDER"
                  Icon="AGI.Captor.ico" />
        <RegistryValue Root="HKCU" 
                       Key="Software\AGI\Captor" 
                       Name="desktop_shortcut" 
                       Type="integer" 
                       Value="1" 
                       KeyPath="yes" />
      </Component>
    </DirectoryRef>

    <!-- 图标 -->
    <Icon Id="AGI.Captor.ico" SourceFile="$(var.SourceDir)\logo.ico" />

    <!-- 注册表项 -->
    <DirectoryRef Id="INSTALLFOLDER">
      <Component Id="RegistryEntries" Guid="12345678-1234-1234-1234-123456789015">
        <RegistryKey Root="HKLM" Key="SOFTWARE\AGI\Captor">
          <RegistryValue Name="InstallPath" Type="string" Value="[INSTALLFOLDER]" />
          <RegistryValue Name="Version" Type="string" Value="1.2.0" />
        </RegistryKey>
        
        <!-- 文件关联（可选） -->
        <RegistryKey Root="HKLM" Key="SOFTWARE\Classes\.agicap">
          <RegistryValue Type="string" Value="AGI.Captor.Document" />
        </RegistryKey>
        
        <RegistryKey Root="HKLM" Key="SOFTWARE\Classes\AGI.Captor.Document">
          <RegistryValue Type="string" Value="AGI Captor Document" />
          <RegistryKey Key="DefaultIcon">
            <RegistryValue Type="string" Value="[INSTALLFOLDER]AGI.Captor.Desktop.exe,0" />
          </RegistryKey>
          <RegistryKey Key="shell\open\command">
            <RegistryValue Type="string" Value="&quot;[INSTALLFOLDER]AGI.Captor.Desktop.exe&quot; &quot;%1&quot;" />
          </RegistryKey>
        </RegistryKey>
      </Component>
    </DirectoryRef>

    <!-- UI配置 -->
    <UI>
      <UIRef Id="WixUI_InstallDir" />
      <Publish Dialog="WelcomeDlg" Control="Next" Event="NewDialog" Value="InstallDirDlg" Order="2">1</Publish>
      <Publish Dialog="InstallDirDlg" Control="Back" Event="NewDialog" Value="WelcomeDlg" Order="2">1</Publish>
    </UI>

    <!-- 许可协议 -->
    <WixVariable Id="WixUILicenseRtf" Value="$(var.SourceDir)\License.rtf" />
    
    <!-- 自定义属性 -->
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
    <Property Id="ARPPRODUCTICON" Value="AGI.Captor.ico" />
    <Property Id="ARPURLINFOABOUT" Value="https://github.com/AGIBuild/AGI.Captor" />
    <Property Id="ARPNOMODIFY" Value="1" />
  </Product>

  <!-- 组件组定义 -->
  <Fragment>
    <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
      <!-- 主要组件在这里通过Heat工具自动生成 -->
      <!-- 这将在构建时由WiX Heat工具填充 -->
    </ComponentGroup>
  </Fragment>
</Wix>